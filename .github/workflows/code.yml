name: Manage Codespace

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  manage-codespace:
    runs-on: ubuntu-latest

    steps:
      - name: Get repository ID
        id: repo
        env:
          GITHUB_TOKEN: ${{ secrets.FULL_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          echo "Fetching repository ID for $REPO..."
          REPO_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/repos/$REPO | jq -r .id)
          echo "repo_id=$REPO_ID" >> $GITHUB_OUTPUT

      - name: Check if Codespace exists
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.FULL_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/user/codespaces)

          if echo "$RESPONSE" | grep -q "\"full_name\": \"$REPO\""; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Codespace if not exists
        if: steps.check.outputs.found == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.FULL_TOKEN }}
          REPO_ID: ${{ steps.repo.outputs.repo_id }}
        run: |
          echo "Creating new codespace for repo ID $REPO_ID..."
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user/codespaces \
            -d "{\"repository_id\": $REPO_ID, \"ref\": \"main\", \"machine\": \"basicLinux\"}" | jq .

      - name: Start Codespace if exists
        if: steps.check.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.FULL_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          CODESPACE_NAME=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/user/codespaces \
            | jq -r ".codespaces[] | select(.repository.full_name==\"$REPO\") | .name")

          if [ -z "$CODESPACE_NAME" ]; then
            echo "No codespace name found for $REPO"
            exit 1
          fi

          echo "Starting codespace $CODESPACE_NAME..."
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/user/codespaces/${CODESPACE_NAME}/start"
